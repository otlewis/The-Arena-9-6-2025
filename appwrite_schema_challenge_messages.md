# Appwrite Collection Schema: challenge_messages

## Collection Details
- **Collection ID**: `challenge_messages`
- **Name**: Challenge Messages
- **Description**: Persistent storage for debate challenge messages with realtime capabilities

## Attributes

### Core Challenge Data
- **challengerId** (String, Required, Size: 255)
  - User ID of the person sending the challenge
  - Index: Yes

- **challengedId** (String, Required, Size: 255)  
  - User ID of the person being challenged
  - Index: Yes

- **challengerName** (String, Required, Size: 100)
  - Display name of challenger (cached for performance)

- **challengerAvatar** (String, Optional, Size: 500)
  - Avatar URL of challenger (cached for performance)

- **topic** (String, Required, Size: 200)
  - The debate topic/question

- **description** (String, Optional, Size: 1000)
  - Additional details about the challenge

- **position** (String, Required, Size: 20)
  - Challenger's chosen position: "affirmative" or "negative"
  - Default: "affirmative"

### Message Status & Timing
- **status** (String, Required, Size: 20)
  - Message status: "pending", "accepted", "declined", "expired"
  - Default: "pending"
  - Index: Yes

- **createdAt** (DateTime, Required)
  - When the challenge was sent
  - Auto-generated by Appwrite

- **expiresAt** (DateTime, Required)
  - When the challenge expires (24 hours from creation)

- **respondedAt** (DateTime, Optional)
  - When the challenge was accepted/declined

- **dismissedAt** (DateTime, Optional)
  - When user clicked "I'll decide later" (keeps in list but dismisses modal)

### Arena Integration
- **arenaRoomId** (String, Optional, Size: 255)
  - Arena room ID if challenge was accepted
  - Links to arena_rooms collection

### Message Metadata
- **messageType** (String, Required, Size: 50)
  - Always "challenge" for this collection
  - Allows for future message types

- **priority** (Integer, Required)
  - Message priority (1-5, where 5 is highest)
  - Default: 3

## Indexes

1. **recipient_pending**
   - Fields: challengedId (ASC), status (ASC), createdAt (DESC)
   - Purpose: Fast retrieval of pending challenges for a user

2. **sender_tracking**
   - Fields: challengerId (ASC), createdAt (DESC)
   - Purpose: Track challenges sent by a user

3. **status_cleanup**
   - Fields: status (ASC), expiresAt (ASC)
   - Purpose: Cleanup expired challenges

## Permissions

### Document-level Permissions
- **Create**: `user:$challengerId` (only challenger can create)
- **Read**: `user:$challengerId`, `user:$challengedId` (both parties can read)
- **Update**: `user:$challengerId`, `user:$challengedId` (both parties can update status)
- **Delete**: `user:$challengerId` (only challenger can delete)

### Collection-level Permissions
- **Create**: Any authenticated user
- **Read**: Owner and recipient only
- **Update**: Owner and recipient only
- **Delete**: Owner only

## Realtime Channels

The collection will use Appwrite's realtime subscriptions:
- **Channel**: `databases.arena_db.collections.challenge_messages.documents`
- **Events**: `create`, `update`, `delete`

## Data Validation Rules

1. **challengerId** â‰  **challengedId** (can't challenge yourself)
2. **expiresAt** > **createdAt** (expiry must be in future)
3. **status** must be one of: pending, accepted, declined, expired
4. **position** must be one of: affirmative, negative
5. **topic** minimum length: 3 characters
6. **messageType** must be "challenge"

## Sample Document
```json
{
  "$id": "64f2a1b3c4d5e6f7g8h9i0j1",
  "$createdAt": "2024-01-15T10:30:00.000Z",
  "$updatedAt": "2024-01-15T10:30:00.000Z",
  "$permissions": [
    "read(\"user:challenger123\")",
    "read(\"user:challenged456\")",
    "update(\"user:challenger123\")",
    "update(\"user:challenged456\")",
    "delete(\"user:challenger123\")"
  ],
  "challengerId": "challenger123",
  "challengedId": "challenged456", 
  "challengerName": "Alice Smith",
  "challengerAvatar": "https://example.com/avatar.jpg",
  "topic": "Should AI replace human judges?",
  "description": "An interesting debate about AI in legal systems",
  "position": "affirmative",
  "status": "pending",
  "expiresAt": "2024-01-16T10:30:00.000Z",
  "respondedAt": null,
  "dismissedAt": null,
  "arenaRoomId": null,
  "messageType": "challenge",
  "priority": 3
}
```

## Migration Notes

When implementing this schema:
1. Create the collection with all attributes first
2. Set up indexes for performance
3. Configure permissions carefully
4. Test realtime subscriptions
5. Implement cleanup function for expired challenges
6. Add validation functions in your app code 